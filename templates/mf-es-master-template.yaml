# Â© Copyright 2018 Micro Focus or one of its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  "This template deploys a Micro Focus Enterprise Server stack into a new VPC.
  **WARNING** This template creates EC2 instances and related resources. You
  will be billed for the AWS resources used if you create a stack from this
  template. License: Apache 2.0 (Please do not remove) Sept,05,2018. Micro Focus
  Enterprise Server is licensed separately, please review the terms and conditions
  here (https://www.microfocus.com/about/legal/) for further details. (qs-1p440hhtu)"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Software License Agreement
        Parameters:
          - LicenseAgreement
          - ESLicenseFilename

      - Label:
          default: Network Configuration
        Parameters:
          - AvailabilityZones
          - VPCCIDR
          - PrivateSubnet1ACIDR
          - PrivateSubnet2ACIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR

      - Label:
          default: Microsoft Active Directory Configuration
        Parameters:
          - DomainDNSName
          - DomainNetBIOSName
          - DomainAdminUser
          - DomainAdminPassword
          - DomainAdminPasswordConfirm

      - Label:
          default: Microsoft Remote Desktop Gateway Configuration
        Parameters:
          - NumberOfRDGWHosts
          - RDGWInstanceType
          - RDGWCIDR

      - Label:
          default: Enterprise Server Configuration
        Parameters:
          - ESInstanceType
          - NumberESInstance
          - KeyPairName
          - RegionsPerInstance
          - AdditonalESStorageinGiB
          - ESCCITCPListenerPort
          - ESCWLogGroupRetentionInDays
          - ESResourceNamePrefix
          - OperatorEmail
          - ESS3BucketName
          - ESS3KeyPrefix

      - Label:
          default: Fileshare Configuration
        Parameters:
          - FileshareType
          - FSInstanceType
          - FSStorageInGiB
          - FSCCITCPListenerPort

      - Label:
          default: Database Configuration
        Parameters:
          - DatabaseType
          - DBInstanceClass
          - DBStorageInGiB
          - DBMasterUsername
          - DBMasterUserPassword
          - DBMasterUserPasswordConfirm
          - DeployMultiAZ
          - DBBackupRetentionPeriod
          - DBPreferredBackupWindow
          - DBPreferredMaintenanceWindow

      - Label:
          default: Enterprise Server Demo Apps Configuration
        Parameters:
          - InstallFSDemoApp
          - InstallSQLDemoApp
          - ESDemoUserPassword
          - ESDemoUserPasswordConfirm
          - DemoAppsIngressCIDR
          - FSDemoApp3270Port
          - SQLDemoApp3270Port

      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix

    ParameterLabels:
      AdditonalESStorageinGiB:
        default: Additional Enterprise Server instance storage
      AvailabilityZones:
        default: Availability Zones
      DBBackupRetentionPeriod:
        default: Database backup retention period
      DBInstanceClass:
        default: Database instance class
      DBMasterUserPassword:
        default: Database Master User password
      DBMasterUserPasswordConfirm:
        default: Re-enter database Master User password
      DBMasterUsername:
        default: Database Master username
      DBPreferredBackupWindow:
        default: Database preferred backup window
      DBPreferredMaintenanceWindow:
        default: Database preferred maintenance window
      DBStorageInGiB:
        default: Database storage
      DatabaseType:
        default: Database type
      DemoAppsIngressCIDR:
        default: Allowed Demo Apps external access CIDR
      DeployMultiAZ:
        default: Deploy in multiple Availability Zones
      DomainAdminUser:
        default: Domain admin username
      DomainAdminPassword:
        default: Domain admin password
      DomainAdminPasswordConfirm:
        default: Re-enter Domain admin password
      DomainDNSName:
        default: Domain DNS name
      DomainNetBIOSName:
        default: Domain NetBIOS name
      ESCCITCPListenerPort:
        default: Enterprise Server CCITCP listener port
      ESCWLogGroupRetentionInDays:
        default: CloudWatch log retention
      ESDemoUserPassword:
        default: Enterprise Server Demo User password
      ESDemoUserPasswordConfirm:
        default: Re-enter Enterprise Server Demo User password
      ESInstanceType:
        default: Enterprise Server instance type
      NumberESInstance:
        default: Number of Enterprise Server Instances to start
      ESLicenseFilename:
        default: Enterprise Server license filename
      ESResourceNamePrefix:
        default: Resource 'Name' prefix
      ESS3BucketName:
        default: Enterprise Server S3 bucket name
      ESS3KeyPrefix:
        default: Enterprise Server S3 key prefix
      FSInstanceType:
        default: Enterprise Server Fileshare instance type
      FSCCITCPListenerPort:
        default: Enterprise Server Fileshare CCITCP listener port
      FSStorageInGiB:
        default: Fileshare storage size
      FileshareType:
        default: Fileshare type
      FSDemoApp3270Port:
        default: Fileshare Bank Demo TN3270 Port
      InstallFSDemoApp:
        default: Install Fileshare Demo App
      InstallSQLDemoApp:
        default: Install SQLServer Demo App
      KeyPairName:
        default: Key Pair Name
      LicenseAgreement:
        default: License agreement
      NumberOfRDGWHosts:
        default: Number of Remote Desktop Gateway hosts
      OperatorEmail:
        default: Operator email address
      PrivateSubnet1ACIDR:
        default: Private Subnet 1A CIDR
      PrivateSubnet2ACIDR:
        default: Private Subnet 2A CIDR
      PublicSubnet1CIDR:
        default: Public Subnet 1A CIDR
      PublicSubnet2CIDR:
        default: Public Subnet 2A CIDR
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      RDGWCIDR:
        default: Allowed Remote Desktop Gateway external access CIDR
      RDGWInstanceType:
        default: Remote Desktop Gateway instance type
      RegionsPerInstance:
        default: 'Number of Enterprise Server "Regions" per instance'
      SQLDemoApp3270Port:
        default: SQLServer Bank Demo TN3270 Port
      VPCCIDR:
        default: VPC CIDR
Parameters:
  AdditonalESStorageinGiB:
    Type: Number
    Description: Enter 0-16384 GiB. Additional EBS storage capacity added to Enterprise Server instances.
    MinValue: 0
    MaxValue: 16384
    Default: 100

  AvailabilityZones:
    Description: >-
      List of Availability Zones to use for the subnets in the VPC. Only two
      Availability Zones are used for this deployment, and the logical order of
      your selections is preserved.
    Type: 'List<AWS::EC2::AvailabilityZone::Name>'

  DatabaseType:
    AllowedValues:
      - None
      - Create-RDS-Remote-Database
    Default: Create-RDS-Remote-Database
    Description: 'If ''None'', the remaining Database Configuration parameters are ignored'
    Type: String

  DBBackupRetentionPeriod:
    Default: 30
    Type: String

  DBInstanceClass:
    AllowedValues:
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r2.8xlarge
    Default: db.r4.large
    Type: String

  DBMasterUsername:
    Default: DBAdmin
    Type: String

  DBMasterUserPassword:
    Type: String
    NoEcho: true

  DBMasterUserPasswordConfirm:
    Type: String
    NoEcho: true

  DBPreferredBackupWindow:
    Description: >-
      Must be in the format hh24:mi-hh24:mi, in UTC. Must be at least 30
      minutes. Must not conflict with the preferred maintenance window.
    Type: String

  DBPreferredMaintenanceWindow:
    Description: >-
      Must be in the format ddd:hh24:mi-ddd:hh24:mi, in UTC. Must be at least 30
      minutes.
    Type: String

  DBStorageInGiB:
    Type: Number
    Description: Enter 1-16384 GiB
    MinValue: 1
    MaxValue: 16384
    Default: 100

  DemoAppsIngressCIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Default: 0.0.0.0/0
    Description: Allowed CIDR Block for external access to the Demo Apps
    Type: String

  DeployMultiAZ:
    AllowedValues:
      - True
      - False
    Default: False
    Description: >-
      Choose 'True' to deploy the database across multiple Availability Zones
    Type: String


  DomainAdminPassword:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Password for the domain admin user. Must be at least 8 characters
      containing letters, numbers and symbols
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String

  DomainAdminPasswordConfirm:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Confirm Password for the domain admin user. Must be at least 8 characters
      containing letters, numbers and symbols
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String

  DomainAdminUser:
    AllowedPattern: '[a-zA-Z0-9]*'
    Default: Admin
    Description: >-
      User name for the domain administrator. This is separate from the default
      "Administrator" account
    MaxLength: '25'
    MinLength: '5'
    Type: String

  DomainDNSName:
    AllowedPattern: '[a-zA-Z0-9\-]+\..+'
    Default: example.com
    Description: Fully qualified domain name (FQDN) e.g. example.com
    MaxLength: '255'
    MinLength: '2'
    Type: String


  DomainNetBIOSName:
    AllowedPattern: '[a-zA-Z0-9\-]+'
    Default: example
    Description: >-
      NetBIOS name of the domain (up to 15 characters) for users of earlier
      versions of Windows e.g. EXAMPLE
    MaxLength: '15'
    Type: String

  ESCCITCPListenerPort:
    ConstraintDescription: The port number must be between 1 and 65535
    Default: 86
    Description: TCP Port in the range 1-65535
    MaxValue: 65535
    MinValue: 1
    Type: Number

  ESCWLogGroupRetentionInDays:
    Default: 7
    Description: The number of days log events are kept in AWS CloudWatch Logs.
    Type: Number

  ESDemoUserPassword:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Password for ESDemoUser. Must be at least 8 characters
      containing letters, numbers and symbols
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String

  ESDemoUserPasswordConfirm:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Confirm password for the ESDemoUser . Must be at least 8 characters
      containing letters, numbers and symbols
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String

  ESInstanceType:
    AllowedValues:
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
    Default: c5.large
    Type: String

  NumberESInstance:
    AllowedValues:
      - 1
      - 2
    Default: 1
    Description: >- 
      The number of Enterprise Server Instances to start.
    Type: Number

  ESLicenseFilename:
    Description: 'Place the license file obtained from Micro Focus in the S3 bucket folder: s3://<ESS3BucketName>/<ESS3KeyPrefix>/license/'
    Type: String

  ESResourceNamePrefix:
    Default: 'AWS::StackName'
    Description: >-
      Used to prefix resource 'Name' tags. Leave empty for no prefix,
      'AWS::StackName' or a value such as the parent stacks' name
    Type: String

  ESS3BucketName:
    AllowedPattern: '^[a-z0-9][a-z0-9-.]*$'
    Description: >-
      Name of the existing S3 bucket used to store/retrieve objects specific to
      this stack. This string can include numbers, lowercase letters, uppercase
      letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String

  ESS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription: >-
      Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).
    Default: /
    Description: >-
      S3 key prefix for the Quick Start assets. Quick Start key prefix can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String

  FSCCITCPListenerPort:
    ConstraintDescription: The port number must be between 1 and 65535
    Default: 3000
    Description: TCP Port in the range 1-65535
    MaxValue: 65535
    MinValue: 1
    Type: Number

  FSDemoApp3270Port:
    AllowedPattern: >-
      ^([1-9]|[1-8][0-9]|9[0-9]|[1-8][0-9]{2}|9[0-8][0-9]|99[0-9]|[1-8][0-9]{3}|9[0-8][0-9]{2}|99[0-8][0-9]|999[0-9]|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$
    ConstraintDescription: TN3270 Port must be a number (1-65535)
    Default: '5555'
    Type: String

  FSInstanceType:
    AllowedValues:
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
    Default: c5.large
    Type: String

  FSStorageInGiB:
    Default: 250
    Description: Enter 1-16384 GiB
    MaxValue: 16384
    MinValue: 1
    Type: Number

  FileshareType:
    AllowedValues:
      - None
      - Create-Remote-Fileshare-Server
    Default: Create-Remote-Fileshare-Server
    Description: 'If ''None'', the remaining Fileshare Configuration parameters are ignored'
    Type: String

  InstallFSDemoApp:
    Type: String
    AllowedValues:
      - True
      - False
    Default: True
    Description: >-
      Choose 'False' to not install the Enterprise Server Fileshare demo app. Requires
      selection of the 'Create-Remote-Fileshare-Server' Fileshare Type

  InstallSQLDemoApp:
    AllowedValues:
    - True
    - False
    Default: True
    Description: >-
      Choose 'False' to not install the Enterprise Server SQLServer demo app.
      Requires selection of the 'Create-RDS-Remote-Database' Database Type
    Type: String

  KeyPairName:
    Description: >-
      Name of an existing EC2 key pair. All instances will launch with this key
      pair.
    Type: 'AWS::EC2::KeyPair::KeyName'

  LicenseAgreement:
    Description: I have read and agree to the license terms for Micro Focus Enterprise Server (https://www.microfocus.com/documentation/enterprise-developer/ed-latest/ES-WIN/GUID-0562B3C9-2271-4CE8-AF64-93DE4940077F.html).
    Type: String
    Default: '-'
    AllowedValues:
    - I agree
    - '-'
    ConstraintDescription: must answer 'I agree'

  NumberOfRDGWHosts:
    AllowedValues:
      - None
      - '1'
      - '2'
      - '3'
      - '4'
    Default: '1'
    Description: >-
      If 'None', the remaining Microsoft Remote Desktop Gateway Configuration
      parameters are ignored
    Type: String

  OperatorEmail:
    AllowedPattern: >-
      (?i)^None$|([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)
    ConstraintDescription: Must be a valid email address.
    Description: (optional) Email address that notifications are sent to (database, VM failures etc)
    Type: String
    Default: 'None'

  PrivateSubnet1ACIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Description: CIDR block for private subnet 1 located in Availability Zone 1
    Type: String

  PrivateSubnet2ACIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: CIDR block for private subnet 2 located in Availability Zone 2
    Type: String

  PublicSubnet1CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Description: CIDR block for the public (DMZ) subnet 1 located in Availability Zone 1
    Type: String

  PublicSubnet2CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Description: CIDR block for the public (DMZ) subnet 2 located in Availability Zone 2
    Type: String

  QSS3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: >-
      Quick Start bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart
    Description: >-
      S3 bucket name for the Quick Start assets. Quick Start bucket name can
      include numbers, lowercase letters, uppercase letters, and hyphens (-). It
      cannot start or end with a hyphen (-).
    Type: String

  QSS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription: >-
      Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).
    Default: quickstart-microfocus-amc/
    Description: >-
      S3 key prefix for the Quick Start assets. Quick Start key prefix can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String

  RDGWCIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Default: 0.0.0.0/0
    Description: Allowed CIDR Block for external access to the Remote Desktop Gateway
    Type: String

  RDGWInstanceType:
    AllowedValues:
      - t2.large
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
    Default: t2.large
    Description: Amazon EC2 instance type for Remote Desktop Gateway instances
    Type: String

  RegionsPerInstance:
    ConstraintDescription: Must be between 1 and 10 regions per instance
    Default: 1
    MaxValue: 10
    MinValue: 1
    Type: Number

  SQLDemoApp3270Port:
    AllowedPattern: >-
      ^([1-9]|[1-8][0-9]|9[0-9]|[1-8][0-9]{2}|9[0-8][0-9]|99[0-9]|[1-8][0-9]{3}|9[0-8][0-9]{2}|99[0-8][0-9]|999[0-9]|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$
    ConstraintDescription: TN3270 Port must be a number (1-65535)
    Default: '5349'
    Type: String

  VPCCIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC
    Type: String

Rules:
  LicenseAgreementRule:
    Assertions:
    - Assert:
        Fn::Contains:
        - - I agree
        - Ref: LicenseAgreement
      AssertDescription: User must agree to the terms of the license agreement.
  DomainAdminPasswordsMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref DomainAdminPassword
          - !Ref DomainAdminPasswordConfirm
        AssertDescription: Domain Admin user password values do not match.
  DBMasterUserPasswordMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref DBMasterUserPassword
          - !Ref DBMasterUserPasswordConfirm
        AssertDescription: Database Master User password values do not match.
  ESDemoUserPasswordMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref ESDemoUserPassword
          - !Ref ESDemoUserPasswordConfirm
        AssertDescription: Enterprise Server Demo user password values do not match.
  InstallFSDemoAppRule:
    RuleCondition: !Equals
      - !Ref InstallFSDemoApp
      - "true"
    Assertions:
      - Assert: !Not
          - !Equals
            - !Ref FileshareType
            - "None"
        AssertDescription: Either choose a Fileshare Type or select 'False' for Install Fileshare Demo App parameter
  InstallSQLDemoAppRule:
    RuleCondition: !Equals
      - !Ref InstallSQLDemoApp
      - "true"
    Assertions:
      - Assert: !Not
          - !Equals
            - !Ref DatabaseType
            - "None"
        AssertDescription: Either choose a Database Type or select 'False' for Install SQLServer Demo App parameter
Conditions:

  IncludeRDGW: !Not
    - !Equals
      - !Ref NumberOfRDGWHosts
      - None

  InstallingAtLeastOneDemoApp: !Or
    - !Condition InstallingFSDemoApp
    - !Condition InstallingSQLDemoApp

  InstallingFSDemoApp: !Equals
    - !Ref InstallFSDemoApp
    - "true"

  InstallingSQLDemoApp: !Equals
    - !Ref InstallSQLDemoApp
    - "true"

  GovCloudCondition: !Equals
    - !Ref 'AWS::Region'
    - us-gov-west-1

Resources:

  VPCStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - >-
          https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template
        - QSS3Region: !If
            - GovCloudCondition
            - s3-us-gov-west-1
            - s3
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        KeyPairName: !Ref KeyPairName
        NumberOfAZs: '2'
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1ACIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2ACIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        VPCCIDR: !Ref VPCCIDR

  DSMicrosoftAD:
    # See https://aws.amazon.com/blogs/database/integrate-amazon-rds-for-sql-server-db-instances-with-an-existing-active-directory-domain/
    Type: AWS::DirectoryService::MicrosoftAD
    Properties:
      Edition: Standard
      Name: !Ref DomainDNSName
      ShortName: !Ref DomainNetBIOSName
      Password: !Ref DomainAdminPassword
      VpcSettings:
        VpcId: !GetAtt VPCStack.Outputs.VPCID
        SubnetIds:
          - !GetAtt VPCStack.Outputs.PrivateSubnet1AID
          - !GetAtt VPCStack.Outputs.PrivateSubnet2AID

  ADDNSInDDHCPOptions:
    Type: 'AWS::EC2::DHCPOptions'
    Properties:
      DomainName: !Ref DomainDNSName
      DomainNameServers: !GetAtt DSMicrosoftAD.DnsIpAddresses
      Tags:
        - Key: Domain
          Value: !Ref DomainDNSName

  VPCDHCPOptionsAssociation:
    Type: 'AWS::EC2::VPCDHCPOptionsAssociation'
    Properties:
      VpcId: !GetAtt VPCStack.Outputs.VPCID
      DhcpOptionsId: !Ref ADDNSInDDHCPOptions

  VPCDHCPOptionsAssociationCreateWaitHandle:
    DependsOn: DSMicrosoftAD
    Type: "AWS::CloudFormation::WaitConditionHandle"

  VPCDHCPOptionsAssociationWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !Ref VPCDHCPOptionsAssociationCreateWaitHandle
      Timeout: "1"
      Count: 0

  DomainMemberSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: Security group for Windows Domain Member communication
      SecurityGroupIngress:
        - Description: >-
            Direct-hosted SMB traffic without a (NetBIOS) system
          IpProtocol: udp
          FromPort: 445
          ToPort: 445
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Direct-hosted SMB traffic without a (NetBIOS) system
          IpProtocol: tcp
          FromPort: 445
          ToPort: 445
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Microsoft file sharing SMB
          IpProtocol: udp
          FromPort: 135
          ToPort: 139
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Microsoft file sharing SMB
          IpProtocol: tcp
          FromPort: 135
          ToPort: 139
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Domain Name System (DNS)
          IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Domain Name System (DNS)
          IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: !Ref VPCCIDR
        - Description: >-
            WinRM, Windows PowerShell Default psSession Port
          IpProtocol: tcp
          FromPort: 5985
          ToPort: 5985
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Windows dynamic TCP ports
          IpProtocol: tcp
          FromPort: 49152
          ToPort: 65535
          CidrIp: !Ref VPCCIDR
        - Description: >-
            Windows dynamic UDP ports
          IpProtocol: udp
          FromPort: 49152
          ToPort: 65535
          CidrIp: !Ref VPCCIDR
      VpcId: !GetAtt VPCStack.Outputs.VPCID

  RDGWStack:
    Type: 'AWS::CloudFormation::Stack'
    Condition: IncludeRDGW
    DependsOn: VPCDHCPOptionsAssociationWaitCondition
    Properties:
      TemplateURL: !Sub
        - >-
          https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-microsoft-rdgateway/templates/rdgw-domain.template
        - QSS3Region: !If
            - GovCloudCondition
            - s3-us-gov-west-1
            - s3
      Parameters:
        DomainDNSName: !Ref DomainDNSName
        DomainNetBIOSName: !Ref DomainNetBIOSName
        DomainMemberSGID: !Ref DomainMemberSG
        DomainAdminUser: !Ref DomainAdminUser
        DomainAdminPassword: !Ref DomainAdminPassword
        KeyPairName: !Ref KeyPairName
        NumberOfRDGWHosts: !Ref NumberOfRDGWHosts
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        QSS3BucketName: aws-quickstart
        QSS3KeyPrefix: quickstart-microsoft-rdgateway/
        RDGWCIDR: !Ref RDGWCIDR
        RDGWInstanceType: !Ref RDGWInstanceType
        VPCID: !GetAtt VPCStack.Outputs.VPCID

  RDGWCreateWaitHandle:
    Condition: IncludeRDGW
    DependsOn: RDGWStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  NoRDGWWaitHandle:
    Type: "AWS::CloudFormation::WaitConditionHandle"
    DependsOn: VPCDHCPOptionsAssociationWaitCondition

  RDGWWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [IncludeRDGW, !Ref RDGWCreateWaitHandle, !Ref NoRDGWWaitHandle]
      Timeout: "1"
      Count: 0

  EnterpriseServerWorkloadStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn: [VPCDHCPOptionsAssociationWaitCondition, RDGWWaitCondition]
    Properties:
      TemplateURL: !Sub
        - >-
          https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}templates/mf-es-workload-template.yaml
        - QSS3Region: !If
            - GovCloudCondition
            - s3-us-gov-west-1
            - s3
      Parameters:
        AdditonalESStorageinGiB: !Ref AdditonalESStorageinGiB
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        DatabaseType: !Ref DatabaseType
        DBBackupRetentionPeriod: !Ref DBBackupRetentionPeriod
        DBInstanceClass: !Ref DBInstanceClass
        DBMasterUsername: !Ref DBMasterUsername
        DBMasterUserPassword: !Ref DBMasterUserPassword
        DBMasterUserPasswordConfirm: !Ref DBMasterUserPasswordConfirm
        DBPreferredBackupWindow: !Ref DBPreferredBackupWindow
        DBPreferredMaintenanceWindow: !Ref DBPreferredMaintenanceWindow
        DBStorageInGiB: !Ref DBStorageInGiB
        DemoAppsIngressCIDR: !Ref DemoAppsIngressCIDR
        DeployMultiAZ: !Ref DeployMultiAZ
        DirectoryServiceID: !Ref DSMicrosoftAD
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainAdminPasswordConfirm: !Ref DomainAdminPasswordConfirm
        DomainAdminUser: !Ref DomainAdminUser
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSG
        DomainNetBIOSName: !Ref DomainNetBIOSName
        ESCCITCPListenerPort: !Ref ESCCITCPListenerPort
        ESCWLogGroupRetentionInDays: !Ref ESCWLogGroupRetentionInDays
        ESDemoUserPassword: !Ref ESDemoUserPassword
        ESDemoUserPasswordConfirm: !Ref ESDemoUserPasswordConfirm
        ESInstanceType: !Ref ESInstanceType
        NumberESInstance: !Ref NumberESInstance
        ESLicenseFilename: !Ref ESLicenseFilename
        ESResourceNamePrefix: !Ref ESResourceNamePrefix
        ESS3BucketName: !Ref ESS3BucketName
        ESS3KeyPrefix: !Ref ESS3KeyPrefix
        FileshareType: !Ref FileshareType
        FSCCITCPListenerPort: !Ref FSCCITCPListenerPort
        FSDemoApp3270Port: !Ref FSDemoApp3270Port
        FSInstanceType: !Ref FSInstanceType
        FSStorageInGiB: !Ref FSStorageInGiB
        InstallFSDemoApp: !Ref InstallFSDemoApp
        InstallSQLDemoApp: !Ref InstallSQLDemoApp
        KeyPairName: !Ref KeyPairName
        LicenseAgreement: !Ref LicenseAgreement
        OperatorEmail: !Ref OperatorEmail
        PrivateSubnet1AID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2AID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        RDGWAccessSGID: !If
          - IncludeRDGW
          - !GetAtt RDGWStack.Outputs.RemoteDesktopGatewaySGID
          - !Ref AWS::NoValue
        RegionsPerInstance: !Ref RegionsPerInstance
        SQLDemoApp3270Port: !Ref SQLDemoApp3270Port
        VPCID: !GetAtt VPCStack.Outputs.VPCID

Outputs:
  DirectoryServiceID:
    Description: Microsoft directory service ID
    Value: !Ref DSMicrosoftAD

  ESDemoAppsPublicNetworkLoadBalancer:
    Condition: InstallingAtLeastOneDemoApp
    Description: The DNS name of the Enterprise Server public load balancer
    Value: !GetAtt EnterpriseServerWorkloadStack.Outputs.ESDemoAppsPublicNetworkLoadBalancer

  FSDemoApp3270Port:
    Condition: InstallingFSDemoApp
    Description: The Fileshare Bank Demo TN3270 port number
    Value: !GetAtt EnterpriseServerWorkloadStack.Outputs.FSDemoApp3270Port

  RemoteDesktopGatewayIP:
    Condition: IncludeRDGW
    Description: Public IP Address for the Remote Desktop Gateway
    Value: !GetAtt RDGWStack.Outputs.EIP1

  SQLDemoApp3270Port:
    Condition: InstallingSQLDemoApp
    Description: The SQLServer Bank Demo TN3270 port number
    Value: !GetAtt EnterpriseServerWorkloadStack.Outputs.SQLDemoApp3270Port
