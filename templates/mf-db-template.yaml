# Â© Copyright 2018 Micro Focus or one of its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  "This template deploys a Micro Focus Enterprise Server Database instance in
  private subnets.
  **WARNING** This template creates EC2 instances and related resources. You
  will be billed for the AWS resources used if you create a stack from this
  template. Micro Focus Enterprise Server is licensed separately, please review
  the terms and conditions here (https://www.microfocus.com/about/legal/) for
  further details. (qs-1p440hhtu)"
Metadata:
  "AWS::CloudFormation::Interface":
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - VPCID
          - PrivateSubnet1AID
          - PrivateSubnet2AID
      - Label:
          default: Microsoft Active Directory Configuration
        Parameters:
          - DirectoryServiceID
      - Label:
          default: Enterprise Server Database Configuration
        Parameters:
          - DBInstanceClass
          - DBStorageInGiB
          - DBMasterUsername
          - DBMasterUserPassword
          - DBMasterUserPasswordConfirm
          - ESClientAccessSGID
          - NotificationARN
          - ESResourceNamePrefix
          - DeployMultiAZ
          - DBBackupRetentionPeriod
          - DBPreferredBackupWindow
          - DBPreferredMaintenanceWindow
    ParameterLabels:
      DBBackupRetentionPeriod:
        default: Database Backup Retention Period
      DBInstanceClass:
        default: Database Instance Class
      DBMasterUsername:
        default: Database Master Username
      DBMasterUserPassword:
        default: Database Master User password
      DBMasterUserPasswordConfirm:
        default: Re-enter database Master User password
      DBPreferredBackupWindow:
        default: Database Preferred Backup Window
      DBPreferredMaintenanceWindow:
        default: Database Preferred Maintenance Window
      DBStorageInGiB:
        default: Database Storage In GiB
      DeployMultiAZ:
        default: Deploy in multiple AZs
      DirectoryServiceID:
        default: Directory Service ID
      ESClientAccessSGID:
        default: ES Client Access Security Group ID
      ESResourceNamePrefix:
        default: Resource 'Name' Prefix
      NotificationARN:
        default: Notification ARN
      PrivateSubnet1AID:
        default: Private Subnet 1A ID
      PrivateSubnet2AID:
        default: Private Subnet 2A ID
      VPCID:
        default: VPC ID
Parameters:
  DBBackupRetentionPeriod:
    Type: String
    Default: 30

  DBInstanceClass:
    AllowedValues:
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r2.8xlarge
    Default: db.r4.large
    Type: String

  DBPreferredBackupWindow:
    Type: String
    Description: >-
      Must be in the format hh24:mi-hh24:mi, in UTC. Must be at least 30
      minutes. Must not conflict with the preferred maintenance window.
    Default: ''

  DBPreferredMaintenanceWindow:
    Type: String
    Description: >-
      Must be in the format ddd:hh24:mi-ddd:hh24:mi, in UTC. Must be at least 30
      minutes.
    Default: ''

  DBStorageInGiB:
    Type: String
    Default: 1024

  DBMasterUsername:
    Type: String
    Default: DBAdmin

  DBMasterUserPassword:
    Type: String
    NoEcho: true

  DBMasterUserPasswordConfirm:
    Type: String
    NoEcho: true

  DeployMultiAZ:
    AllowedValues:
      - True
      - False
    Default: False
    Description: >-
      Choose 'True' to deploy the database across multiple Availability Zones
    Type: String

  DirectoryServiceID:
    Type: String

  ESClientAccessSGID:
    Type: 'AWS::EC2::SecurityGroup::Id'

  ESResourceNamePrefix:
    Type: String
    Default: 'AWS::StackName'

  NotificationARN:
    Description: An existing Amazon SNS topic where notifications about are sent, e.g., email notifications
    Type: String
    Default: ""

  PrivateSubnet1AID:
    Description: 'ID of private subnet A in Availability Zone 1 (e.g., subnet-a0246dcd)'
    Type: 'AWS::EC2::Subnet::Id'

  PrivateSubnet2AID:
    Description: >-
      ID of private subnet A in Availability Zone 2 (e.g.,
      subnet-01a43dc1ca1fa7f9b)
    Type: 'AWS::EC2::Subnet::Id'

  VPCID:
    Description: ID of your existing VPC for deployment
    Type: 'AWS::EC2::VPC::Id'
Rules:
  SubnetsInVPC:
    Assertions:
      - Assert:
          'Fn::EachMemberIn':
            - 'Fn::ValueOfAll':
                - 'AWS::EC2::Subnet::Id'
                - VpcId
            - 'Fn::RefAll': 'AWS::EC2::VPC::Id'
        AssertDescription: All subnets must in the VPC
  DBMasterUserPasswordMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref DBMasterUserPassword
          - !Ref DBMasterUserPasswordConfirm
        AssertDescription: Database Master User password values do not match.
Conditions:
  NamePrefixIaUndefined: !Equals
    - !Ref ESResourceNamePrefix
    - ''
  NamePrefixIsAWSStackname: !Equals
    - !Ref ESResourceNamePrefix
    - 'AWS::StackName'
  HaveDirectoryService: !Not
    - !Equals
      - !Ref DirectoryServiceID
      - ''
  HaveDBPreferredBackupWindow: !Not
    - !Equals
      - !Ref DBPreferredBackupWindow
      - ''
  HaveDBPreferredMaintenanceWindow: !Not
    - !Equals
      - !Ref DBPreferredMaintenanceWindow
      - ''
  HaveNotificationARN: !Not
    - !Equals
      - !Ref NotificationARN
      - ""
Resources:
  ESDatabaseSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enterprise Server SQL Server Security Group
      VpcId: !Ref VPCID
      SecurityGroupIngress:
      - Description: Allow client access
        IpProtocol: tcp
        FromPort: 1433
        ToPort: 1433
        SourceSecurityGroupId: !Ref ESClientAccessSGID
  ESDatabaseSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: !Sub
        - '${StackNamePrefix}Database Subnet Group'
        - StackNamePrefix: !If
            - NamePrefixIaUndefined
            - ''
            - !If
              - NamePrefixIsAWSStackname
              - !Sub '${AWS::StackName}-'
              - !Sub '${ESResourceNamePrefix}-'
      SubnetIds:
        - !Ref PrivateSubnet1AID
        - !Ref PrivateSubnet2AID
  ESDatabaseADIAMRole:
    Type: 'AWS::IAM::Role'
    Condition: HaveDirectoryService
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - rds.amazonaws.com
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonRDSDirectoryServiceAccess'
  ESDatabase:
    Type: 'AWS::RDS::DBInstance'
    DeletionPolicy: Delete
    Properties:
      DBSubnetGroupName: !Ref ESDatabaseSubnetGroup
      Domain: !If
        - HaveDirectoryService
        - !Ref DirectoryServiceID
        - !Ref 'AWS::NoValue'
      DomainIAMRoleName: !If
        - HaveDirectoryService
        - !Ref ESDatabaseADIAMRole
        - !Ref 'AWS::NoValue'
      AllowMajorVersionUpgrade: False
      AutoMinorVersionUpgrade: True
      PreferredBackupWindow: !If
        - HaveDBPreferredBackupWindow
        - !Ref DBPreferredBackupWindow
        - !Ref 'AWS::NoValue'
      PreferredMaintenanceWindow: !If
        - HaveDBPreferredMaintenanceWindow
        - !Ref DBPreferredMaintenanceWindow
        - !Ref 'AWS::NoValue'
      VPCSecurityGroups:
        - !GetAtt
            - ESDatabaseSG
            - GroupId
      LicenseModel: license-included
      Engine: sqlserver-se
      EngineVersion: 14.00.3035.2.v1
      MultiAZ: !Ref DeployMultiAZ
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref DBStorageInGiB
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterUserPassword
      PubliclyAccessible: False
      Tags:
        - Key: Name
          Value: !Sub
            - '${StackNamePrefix}SQLServer Database'
            - StackNamePrefix: !If
                - NamePrefixIaUndefined
                - ''
                - !If
                  - NamePrefixIsAWSStackname
                  - !Sub '${AWS::StackName}-'
                  - !Sub '${ESResourceNamePrefix}-'
      BackupRetentionPeriod: !Ref DBBackupRetentionPeriod
  ESDatabaseEventSubscriptions:
    Type: AWS::RDS::EventSubscription
    Condition: HaveNotificationARN
    Properties:
      Enabled: True
      EventCategories:
        - "configuration change"
        - "failure"
        - "deletion"
      SnsTopicArn: !Ref NotificationARN
      SourceIds:
        - !Ref ESDatabase
      SourceType: "db-instance"
Outputs:
  ESDatabaseEndpointAddress:
    Description: The connection endpoint for the database
    Value: !GetAtt ESDatabase.Endpoint.Address
  ESDatabaseEndpointPort:
    Description: The port number on which the database accepts connections
    Value: !GetAtt ESDatabase.Endpoint.Port


